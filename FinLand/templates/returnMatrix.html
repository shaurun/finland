<html>
<head>

<style>
    div.chart {
      display: inline-block;
      position: relative;
      width: 70%;
    }
    div.input {
      display: inline-block;
      padding-left: 5px;
      position: absolute;
      left: 70%;
    }
    div#nextSection {
      margin-top: 50px;
    }
   </style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['table']});
      google.charts.setOnLoadCallback(drawTable);
      window.onbeforeunload = closingCode;

      function closingCode(){
          var http = new XMLHttpRequest();
          var url = '/returnMatrix';
           var years = document.getElementById("years").value;
        var sum = document.getElementById("presentValue").value;
        var actualContributions = document.getElementById("actualContributions").value;
          var params = 'years='+ years + '&present_value=' +sum +'&actual_contributions=' +actualContributions;
          http.open('POST', url, true);

            //Send the proper header information along with the request
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            http.setRequestHeader('X-CSRFToken', '{{  csrf_token }}');
          http.send(params);

      }
      
      
      /*
         * ir   - interest rate per month
         * np   - number of periods (months)
         * pv   - present value
         * fv   - future value
         * type - when the payments are due:
         *        0: end of the period, e.g. end of month (default)
         *        1: beginning of period
         */
      function PMT(ir, np, pv, fv, type) {
        var pmt = ( ir * ( pv * Math.pow ( (ir+1), np ) + fv ) ) / ( ( ir + 1 ) * ( Math.pow ( (ir+1), np) -1 ) );
        return pmt;
      }
      
      function maskCurrecnyField(element) {
        text = element.value;
        text = text.replace(new RegExp(',', 'g'), '');
        text = text.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        element.value = text;
      }
      
      function createData(annual) {
        var years = document.getElementById("years").value;
        var sum = document.getElementById("presentValue").value;
        var actualContributions = document.getElementById("actualContributions").value;
        sum = sum.replace(new RegExp(',', 'g'), '');
        actualContributions = actualContributions.replace(new RegExp(',', 'g'), '');
        actualContributions = annual ? actualContributions : actualContributions/12;
        var percents = [5, 6, 7, 8, 9, 10, 12, 15];
        var sumsToReashInMlns = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 25]
        
        var data = new google.visualization.DataTable();
        
        data.addColumn('number', '');
        var formatter = new google.visualization.NumberFormat({prefix: '$', fractionDigits: 0});
        for (var i = 0; i < percents.length; i++) {
           data.addColumn('number', percents[i]+'%');      
        }
        data.addRows(sumsToReashInMlns.length);
        
        for (var i = 0; i < sumsToReashInMlns.length; i++) {
          var sumToReach = 1000000*sumsToReashInMlns[i];
          data.setCell(i, 0, sumToReach, null, {'style': 'font-weight: bold'}); //sum to reach
          
          for (var j = 1; j <= percents.length; j++) {
            var percent = percents[j-1];
            var addPerYear = -PMT(percent/100, years, sum, -sumToReach, 0);
            var value = annual ? addPerYear : addPerYear/12;
      
            data.setCell(i, j, Math.round(value)/1000, null, 
            value < 0 ? {'style': 'background-color: #6fe893; color: grey; font-weight: lighter; min-width:50px;'} : 
            value >= 0.75*actualContributions && value <= 1.15*actualContributions ? 
            {'style': 'background-color: #edd76d; min-width:50px;'} :
            {'style': 'min-width:50px;'});
          }
        }
        
        for (var j = 0; j <= percents.length; j++) {
          formatter.format(data, j); // Apply formatter
        }
        
        return data;
      }

      function drawAnnualTable() {
        var table = new google.visualization.Table(document.getElementById('annual_table_div'));
        table.draw(createData(true), {showRowNumber: false, chartArea:{left:0,top:0}, width: '100%', 'allowHtml': true});
      }
      
      function drawMonthlyTable() {
        var table = new google.visualization.Table(document.getElementById('month_table_div'));
        table.draw(createData(false), {showRowNumber: false, chartArea:{left:0,top:0}, width: '100%', 'allowHtml': true});
      }
      
      function drawTable() {
        drawAnnualTable();
        drawMonthlyTable();
      }
      
</script>
</head>

<body>
<div class="chart">
  <div align="center" bgcolor="#c1ccb5">Annually</div>
  <div id="annual_table_div"></div>
  <div id="nextSection">
    <div align="center" bgcolor="#c1ccb5">Monthly</div>
    <div id="month_table_div"></div>
  </div>
</div>

<div class="input">
<form>
Present value:<br>
<input type="text" oninput="drawTable(); maskCurrecnyField(this)" name="amount" id="presentValue" value="{{ return_matrix.present_value }}"/><br>
Years:<br>  
<input type="text" id="years" oninput="drawTable()" value="{{ return_matrix.years }}"/><br><br>
Actual contributions:<br>  
<input type="text" id="actualContributions" oninput="drawTable(); maskCurrecnyField(this)" value="{{ return_matrix.actual_contributions }}"/><br><br>
</form>
</div>

</body>
</html>